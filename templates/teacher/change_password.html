{% extends "form_base.html" %}

{% block title %}Change Password - Teacher Portal{% endblock %}

{% block sidebar_header %}
<h3><i class="fas fa-chalkboard-teacher"></i> Teacher Portal</h3>
<p class="user-info">{{ user.name }}</p>
{% endblock %}

{% block sidebar_menu %}
<li>
    <a href="{{ url_for('teacher.dashboard') }}">
        <i class="fas fa-tachometer-alt"></i> Dashboard
    </a>
</li>
<li>
    <a href="{{ url_for('teacher.classes') }}">
        <i class="fas fa-users"></i> My Classes
    </a>
</li>
<li>
    <a href="{{ url_for('teacher.attendance') }}">
        <i class="fas fa-calendar-check"></i> Attendance
    </a>
</li>
<li>
    <a href="{{ url_for('teacher.assignments') }}">
        <i class="fas fa-tasks"></i> Assignments
    </a>
</li>
<li class="active">
    <a href="{{ url_for('teacher.profile') }}">
        <i class="fas fa-user"></i> Profile
    </a>
</li>
<li>
    <a href="{{ url_for('teacher.schedule') }}">
        <i class="fas fa-calendar"></i> Schedule
    </a>
</li>
<li>
    <a href="{{ url_for('teacher.reports') }}">
        <i class="fas fa-chart-line"></i> Reports
    </a>
</li>
<li>
    <a href="{{ url_for('auth.logout') }}">
        <i class="fas fa-sign-out-alt"></i> Logout
    </a>
</li>
{% endblock %}

{% block page_title %}Change Password{% endblock %}

{% block header_actions %}
{{ super() }}
<div style="display: flex; gap: var(--spacing-sm);">
    <a href="{{ url_for('teacher.profile') }}" class="btn btn-outline btn-sm">
        <i class="fas fa-arrow-left"></i> Back to Profile
    </a>
</div>
{% endblock %}

{% block form_content %}
<div class="dashboard-grid" style="max-width: 600px; margin: 0 auto;">
    <!-- Security Notice -->
    <div class="dashboard-card" style="grid-column: span 1;">
        <div class="card-header">
            <h3><i class="fas fa-shield-alt"></i> Security Notice</h3>
        </div>
        <div class="card-content">
            <div style="display: grid; gap: var(--spacing-md);">
                <div style="display: flex; align-items: flex-start; gap: var(--spacing-md);">
                    <i class="fas fa-lock" style="color: var(--success); margin-top: var(--spacing-xs);"></i>
                    <div>
                        <div style="color: var(--text-primary); font-weight: 600; margin-bottom: var(--spacing-xs);">Strong Password</div>
                        <div style="color: var(--text-muted); font-size: 0.875rem;">Use at least 8 characters with a mix of letters, numbers, and symbols.</div>
                    </div>
                </div>
                <div style="display: flex; align-items: flex-start; gap: var(--spacing-md);">
                    <i class="fas fa-user-secret" style="color: var(--info); margin-top: var(--spacing-xs);"></i>
                    <div>
                        <div style="color: var(--text-primary); font-weight: 600; margin-bottom: var(--spacing-xs);">Keep it Private</div>
                        <div style="color: var(--text-muted); font-size: 0.875rem;">Never share your password with anyone, including administrators.</div>
                    </div>
                </div>
                <div style="display: flex; align-items: flex-start; gap: var(--spacing-md);">
                    <i class="fas fa-sync-alt" style="color: var(--warning); margin-top: var(--spacing-xs);"></i>
                    <div>
                        <div style="color: var(--text-primary); font-weight: 600; margin-bottom: var(--spacing-xs);">Regular Updates</div>
                        <div style="color: var(--text-muted); font-size: 0.875rem;">Change your password regularly for better security.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Form -->
    <div class="dashboard-card" style="grid-column: span 1;">
        <div class="card-header">
            <h3><i class="fas fa-key"></i> Change Password</h3>
        </div>
        <div class="card-content">
            <form id="changePasswordForm" method="POST">
                <div class="form-group">
                    <label class="form-label" for="current_password">Current Password *</label>
                    <div style="position: relative;">
                        <input type="password" class="form-input" id="current_password" name="current_password" required>
                        <button type="button" class="btn btn-ghost" style="position: absolute; right: var(--spacing-sm); top: 50%; transform: translateY(-50%); padding: var(--spacing-xs);" onclick="togglePassword('current_password')">
                            <i class="fas fa-eye" id="current_password_icon"></i>
                        </button>
                    </div>
                    <small style="color: var(--text-muted);">Enter your current password to verify your identity</small>
                </div>

                <div class="form-group">
                    <label class="form-label" for="new_password">New Password *</label>
                    <div style="position: relative;">
                        <input type="password" class="form-input" id="new_password" name="new_password" required minlength="8">
                        <button type="button" class="btn btn-ghost" style="position: absolute; right: var(--spacing-sm); top: 50%; transform: translateY(-50%); padding: var(--spacing-xs);" onclick="togglePassword('new_password')">
                            <i class="fas fa-eye" id="new_password_icon"></i>
                        </button>
                    </div>
                    <div id="passwordStrength" style="margin-top: var(--spacing-sm);"></div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="confirm_password">Confirm New Password *</label>
                    <div style="position: relative;">
                        <input type="password" class="form-input" id="confirm_password" name="confirm_password" required minlength="8">
                        <button type="button" class="btn btn-ghost" style="position: absolute; right: var(--spacing-sm); top: 50%; transform: translateY(-50%); padding: var(--spacing-xs);" onclick="togglePassword('confirm_password')">
                            <i class="fas fa-eye" id="confirm_password_icon"></i>
                        </button>
                    </div>
                    <div id="passwordMatch" style="margin-top: var(--spacing-sm);"></div>
                </div>

                <div style="margin-top: var(--spacing-xl);">
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-save"></i> Change Password
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Password Requirements -->
    <div class="dashboard-card" style="grid-column: span 1;">
        <div class="card-header">
            <h3><i class="fas fa-list-check"></i> Password Requirements</h3>
        </div>
        <div class="card-content">
            <div id="passwordRequirements" style="display: grid; gap: var(--spacing-sm);">
                <div class="requirement" data-requirement="length">
                    <i class="fas fa-times-circle" style="color: var(--error);"></i>
                    <span>At least 8 characters</span>
                </div>
                <div class="requirement" data-requirement="uppercase">
                    <i class="fas fa-times-circle" style="color: var(--error);"></i>
                    <span>One uppercase letter</span>
                </div>
                <div class="requirement" data-requirement="lowercase">
                    <i class="fas fa-times-circle" style="color: var(--error);"></i>
                    <span>One lowercase letter</span>
                </div>
                <div class="requirement" data-requirement="number">
                    <i class="fas fa-times-circle" style="color: var(--error);"></i>
                    <span>One number</span>
                </div>
                <div class="requirement" data-requirement="special">
                    <i class="fas fa-times-circle" style="color: var(--error);"></i>
                    <span>One special character</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
{{ super() }}
<style>
.requirement {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-size: 0.875rem;
    transition: all 0.3s ease;
}

.requirement.met i {
    color: var(--success) !important;
}

.requirement.met i:before {
    content: "\f058"; /* fa-check-circle */
}

.password-strength {
    height: 4px;
    border-radius: 2px;
    margin-top: var(--spacing-xs);
    transition: all 0.3s ease;
}

.password-strength.weak {
    background-color: var(--error);
    width: 25%;
}

.password-strength.fair {
    background-color: var(--warning);
    width: 50%;
}

.password-strength.good {
    background-color: var(--info);
    width: 75%;
}

.password-strength.strong {
    background-color: var(--success);
    width: 100%;
}
</style>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + '_icon');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        field.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

function checkPasswordStrength(password) {
    let strength = 0;
    const requirements = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /\d/.test(password),
        special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
    };
    
    // Update requirement indicators
    Object.keys(requirements).forEach(req => {
        const element = document.querySelector(`[data-requirement="${req}"]`);
        if (requirements[req]) {
            element.classList.add('met');
            strength++;
        } else {
            element.classList.remove('met');
        }
    });
    
    // Update strength indicator
    const strengthDiv = document.getElementById('passwordStrength');
    strengthDiv.innerHTML = '';
    
    if (password.length > 0) {
        const strengthBar = document.createElement('div');
        strengthBar.className = 'password-strength';
        
        if (strength < 2) {
            strengthBar.classList.add('weak');
            strengthDiv.innerHTML = '<div class="password-strength weak"></div><small style="color: var(--error);">Weak password</small>';
        } else if (strength < 3) {
            strengthBar.classList.add('fair');
            strengthDiv.innerHTML = '<div class="password-strength fair"></div><small style="color: var(--warning);">Fair password</small>';
        } else if (strength < 5) {
            strengthBar.classList.add('good');
            strengthDiv.innerHTML = '<div class="password-strength good"></div><small style="color: var(--info);">Good password</small>';
        } else {
            strengthBar.classList.add('strong');
            strengthDiv.innerHTML = '<div class="password-strength strong"></div><small style="color: var(--success);">Strong password</small>';
        }
    }
    
    return strength;
}

function checkPasswordMatch() {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    const matchDiv = document.getElementById('passwordMatch');
    
    if (confirmPassword.length > 0) {
        if (newPassword === confirmPassword) {
            matchDiv.innerHTML = '<small style="color: var(--success);"><i class="fas fa-check-circle"></i> Passwords match</small>';
            return true;
        } else {
            matchDiv.innerHTML = '<small style="color: var(--error);"><i class="fas fa-times-circle"></i> Passwords do not match</small>';
            return false;
        }
    } else {
        matchDiv.innerHTML = '';
        return false;
    }
}

// Event listeners
document.getElementById('new_password').addEventListener('input', function() {
    checkPasswordStrength(this.value);
    if (document.getElementById('confirm_password').value) {
        checkPasswordMatch();
    }
});

document.getElementById('confirm_password').addEventListener('input', checkPasswordMatch);

// Form submission
document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    
    if (checkPasswordStrength(newPassword) < 3) {
        showNotification('Please choose a stronger password', 'error');
        return;
    }
    
    if (!checkPasswordMatch()) {
        showNotification('Passwords do not match', 'error');
        return;
    }
    
    showNotification('Changing password...', 'info');
    
    // Simulate API call
    setTimeout(() => {
        showNotification('Password changed successfully!', 'success');
        setTimeout(() => {
            window.location.href = '{{ url_for("teacher.profile") }}';
        }, 1500);
    }, 2000);
});

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} fade-in`;
    notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}-circle"></i> ${message}`;
    notification.style.cssText = `
        position: fixed;
        top: var(--spacing-lg);
        right: var(--spacing-lg);
        z-index: 1000;
        max-width: 350px;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}
</script>
{% endblock %}