{% extends "form_base.html" %}

{% block title %}Import Students - School Admin{% endblock %}

{% block sidebar_header %}
<h3><i class="fas fa-user-shield"></i> School Admin</h3>
<p class="user-info">{{ user.name }}</p>
<p class="class-info">{{ school.name if school else 'Administrator' }}</p>
{% endblock %}

{% block sidebar_menu %}
<li>
    <a href="{{ url_for('school_admin.dashboard') }}">
        <i class="fas fa-tachometer-alt"></i> Dashboard
    </a>
</li>
<li class="active">
    <a href="{{ url_for('school_admin.students') }}">
        <i class="fas fa-users"></i> Students
    </a>
</li>
<li>
    <a href="{{ url_for('school_admin.teachers') }}">
        <i class="fas fa-chalkboard-teacher"></i> Teachers
    </a>
</li>
<li>
    <a href="{{ url_for('school_admin.classes') }}">
        <i class="fas fa-school"></i> Classes
    </a>
</li>
<li>
    <a href="{{ url_for('school_admin.fees') }}">
        <i class="fas fa-money-bill-wave"></i> Fees
    </a>
</li>
<li>
    <a href="{{ url_for('school_admin.attendance') }}">
        <i class="fas fa-calendar-check"></i> Attendance
    </a>
</li>
<li>
    <a href="{{ url_for('school_admin.reports') }}">
        <i class="fas fa-chart-line"></i> Reports
    </a>
</li>
<li>
    <a href="{{ url_for('auth.logout') }}">
        <i class="fas fa-sign-out-alt"></i> Logout
    </a>
</li>
{% endblock %}

{% block page_title %}Import Students{% endblock %}

{% block header_actions %}
{{ super() }}
<div style="display: flex; gap: var(--spacing-sm);">
    <a href="{{ url_for('school_admin.students') }}" class="btn btn-outline btn-sm">
        <i class="fas fa-arrow-left"></i> Back to Students
    </a>
    <button type="submit" form="importForm" class="btn btn-primary btn-sm">
        <i class="fas fa-upload"></i> Import Students
    </button>
</div>
{% endblock %}

{% block form_content %}
<div class="dashboard-grid">
    <!-- Import Instructions -->
    <div class="dashboard-card" style="grid-column: span 2;">
        <div class="card-header">
            <h3><i class="fas fa-info-circle"></i> Import Instructions</h3>
            <span class="badge badge-info">Read Carefully</span>
        </div>
        <div class="card-content">
            <div class="alert alert-info">
                <i class="fas fa-lightbulb"></i>
                <strong>Before importing:</strong> Make sure your CSV file follows the correct format and contains all required fields.
            </div>
            
            <h4>Required Fields:</h4>
            <ul style="margin: var(--spacing-md) 0; padding-left: var(--spacing-lg);">
                <li><strong>Name</strong> - Student's full name</li>
                <li><strong>Father Name</strong> - Father's full name</li>
                <li><strong>Mother Name</strong> - Mother's full name</li>
                <li><strong>Gender</strong> - male, female, or other</li>
                <li><strong>Date of Birth</strong> - Format: YYYY-MM-DD</li>
                <li><strong>Phone</strong> - Contact number</li>
                <li><strong>Address</strong> - Complete address</li>
            </ul>
            
            <h4>Optional Fields:</h4>
            <ul style="margin: var(--spacing-md) 0; padding-left: var(--spacing-lg);">
                <li>Admission No (auto-generated if empty)</li>
                <li>Roll Number (auto-generated if empty)</li>
                <li>Class, Email, City, State, Pincode</li>
                <li>Blood Group, PEN No, Admission Date</li>
            </ul>
            
            <div class="alert alert-warning" style="margin-top: var(--spacing-lg);">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Note:</strong> Duplicate admission numbers will be skipped. Make sure your data is clean before importing.
            </div>
        </div>
    </div>

    <!-- Sample CSV Download -->
    <div class="dashboard-card">
        <div class="card-header">
            <h3><i class="fas fa-download"></i> Sample Template</h3>
        </div>
        <div class="card-content" style="text-align: center;">
            <div style="margin-bottom: var(--spacing-lg);">
                <i class="fas fa-file-csv" style="font-size: 4rem; color: var(--success); margin-bottom: var(--spacing-md);"></i>
                <p>Download a sample CSV template with the correct format and example data.</p>
            </div>
            
            <button type="button" class="btn btn-success btn-sm" onclick="downloadSampleCSV()">
                <i class="fas fa-download"></i> Download Sample CSV
            </button>
        </div>
    </div>

    <!-- File Upload -->
    <div class="dashboard-card" style="grid-column: span 3;">
        <div class="card-header">
            <h3><i class="fas fa-upload"></i> Upload CSV File</h3>
        </div>
        <div class="card-content">
            <form id="importForm" method="POST" enctype="multipart/form-data">
                <div class="form-group">
                    <label class="form-label" for="csv_file">Select CSV File *</label>
                    <input type="file" class="form-input" id="csv_file" name="csv_file" accept=".csv" required>
                    <small style="color: var(--text-muted);">Only CSV files are supported. Maximum file size: 5MB</small>
                </div>
                
                <div id="filePreview" style="display: none; margin-top: var(--spacing-lg);">
                    <div class="alert alert-info">
                        <i class="fas fa-file-csv"></i>
                        <span id="fileName"></span>
                        <span id="fileSize" style="color: var(--text-muted);"></span>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: var(--spacing-xl);">
                    <label class="form-checkbox">
                        <input type="checkbox" id="confirmImport" required>
                        <span class="checkmark"></span>
                        I confirm that the CSV file is properly formatted and I want to proceed with the import
                    </label>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
// File preview
document.getElementById('csv_file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('filePreview');
    
    if (file) {
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = `(${formatFileSize(file.size)})`;
        preview.style.display = 'block';
    } else {
        preview.style.display = 'none';
    }
});

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Download sample CSV
function downloadSampleCSV() {
    const csvContent = `Admission No,Roll Number,Name,Father Name,Mother Name,Gender,Date of Birth,Phone,Email,Address,City,State,Pincode,Blood Group,PEN No,Class,Status,Admission Date
STU202400001,01,John Doe,Robert Doe,Mary Doe,male,2010-05-15,9876543210,john@example.com,123 Main Street,Mumbai,Maharashtra,400001,O+,PEN123456,Class 5 A,active,2024-04-01
STU202400002,02,Jane Smith,Michael Smith,Sarah Smith,female,2011-03-20,9876543211,jane@example.com,456 Oak Avenue,Delhi,Delhi,110001,A+,PEN123457,Class 4 B,active,2024-04-01`;
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'student_import_sample.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Form validation
document.getElementById('importForm').addEventListener('submit', function(e) {
    const fileInput = document.getElementById('csv_file');
    const confirmCheckbox = document.getElementById('confirmImport');
    
    if (!fileInput.files[0]) {
        e.preventDefault();
        showNotification('Please select a CSV file', 'error');
        return;
    }
    
    if (!confirmCheckbox.checked) {
        e.preventDefault();
        showNotification('Please confirm that you want to proceed with the import', 'error');
        return;
    }
    
    // Check file size (5MB limit)
    if (fileInput.files[0].size > 5 * 1024 * 1024) {
        e.preventDefault();
        showNotification('File size must be less than 5MB', 'error');
        return;
    }
    
    // Show loading state
    const submitBtn = document.querySelector('button[type="submit"]');
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importing...';
    submitBtn.disabled = true;
    
    showNotification('Importing students... This may take a few moments.', 'info');
});

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} fade-in`;
    notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'}-circle"></i> ${message}`;
    notification.style.cssText = `
        position: fixed;
        top: var(--spacing-lg);
        right: var(--spacing-lg);
        z-index: 1000;
        max-width: 350px;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}
</script>
{% endblock %}