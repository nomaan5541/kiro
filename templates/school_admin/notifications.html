{% extends "content_base.html" %}

{% block title %}Notification Management{% endblock %}

{% block sidebar_header %}
<h3><i class="fas fa-user-shield"></i> School Admin</h3>
<p class="user-info">{{ user.name }}</p>
<p class="class-info">{{ school.name if school else 'Administrator' }}</p>
{% endblock %}

{% block sidebar_menu %}
<li>
    <a href="{{ url_for('school_admin.dashboard') }}">
        <i class="fas fa-tachometer-alt"></i> Dashboard
    </a>
</li>
<li>
    <a href="{{ url_for('school_admin.students') }}">
        <i class="fas fa-users"></i> Students
    </a>
</li>
<li>
    <a href="{{ url_for('school_admin.teachers') }}">
        <i class="fas fa-chalkboard-teacher"></i> Teachers
    </a>
</li>
<li>
    <a href="{{ url_for('school_admin.classes') }}">
        <i class="fas fa-school"></i> Classes
    </a>
</li>
<li>
    <a href="{{ url_for('school_admin.fees') }}">
        <i class="fas fa-money-bill-wave"></i> Fees
    </a>
</li>
<li>
    <a href="{{ url_for('school_admin.attendance') }}">
        <i class="fas fa-calendar-check"></i> Attendance
    </a>
</li>
<li class="active">
    <a href="{{ url_for('school_admin.notifications') }}">
        <i class="fas fa-bell"></i> Notifications
    </a>
</li>
<li>
    <a href="{{ url_for('school_admin.reports') }}">
        <i class="fas fa-chart-line"></i> Reports
    </a>
</li>
<li>
    <a href="{{ url_for('auth.logout') }}">
        <i class="fas fa-sign-out-alt"></i> Logout
    </a>
</li>
{% endblock %}

{% block page_title %}Notification Management{% endblock %}

{% block header_actions %}
{{ super() }}
<div style="display: flex; gap: var(--spacing-sm);">
    <button class="btn btn-outline btn-sm" onclick="showNotificationStats()">
        <i class="fas fa-chart-bar"></i> Statistics
    </button>
    <button class="btn btn-secondary btn-sm" onclick="showTemplateManager()">
        <i class="fas fa-edit"></i> Manage Templates
    </button>
    <button class="btn btn-primary btn-sm" onclick="showSendNotificationModal()">
        <i class="fas fa-paper-plane"></i> Send Notification
    </button>
</div>
{% endblock %}

{% block extra_css %}
{{ super() }}
<style>
/* Notification Management Styles */
.notification-dashboard {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-xl);
    margin-bottom: var(--spacing-xl);
}

.notification-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-xl);
}

.notification-stat-card {
    background: var(--card-bg);
    border-radius: var(--border-radius);
    padding: var(--spacing-lg);
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.notification-stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--accent-orange), var(--accent-blue));
}

.notification-stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.stat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--spacing-md);
}

.stat-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
}

.stat-icon.sms { background: linear-gradient(135deg, #22c55e, #16a34a); }
.stat-icon.whatsapp { background: linear-gradient(135deg, #25d366, #128c7e); }
.stat-icon.email { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
.stat-icon.in-app { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: var(--spacing-xs);
}

.stat-label {
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-bottom: var(--spacing-sm);
}

.stat-details {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
}

.stat-success { color: var(--accent-green); }
.stat-failed { color: var(--accent-red); }
.stat-pending { color: var(--accent-orange); }

.notification-tabs {
    display: flex;
    border-bottom: 1px solid var(--border-color);
    margin-bottom: var(--spacing-lg);
}

.tab-btn {
    padding: var(--spacing-md) var(--spacing-lg);
    border: none;
    background: none;
    color: var(--text-secondary);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.tab-btn.active {
    color: var(--accent-orange);
    border-bottom-color: var(--accent-orange);
}

.tab-btn:hover {
    color: var(--text-primary);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.notification-log-table {
    background: var(--card-bg);
    border-radius: var(--border-radius);
    overflow: hidden;
    border: 1px solid var(--border-color);
}

.log-filters {
    padding: var(--spacing-lg);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    gap: var(--spacing-md);
    align-items: center;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.filter-select {
    padding: var(--spacing-xs) var(--spacing-sm);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    background: var(--input-bg);
    color: var(--text-primary);
    font-size: 0.875rem;
}

.notification-log-item {
    display: grid;
    grid-template-columns: auto 1fr auto auto auto auto;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
    border-bottom: 1px solid var(--border-color);
    align-items: center;
    transition: background-color 0.2s ease;
}

.notification-log-item:hover {
    background: rgba(255, 107, 53, 0.05);
}

.notification-log-item:last-child {
    border-bottom: none;
}

.log-channel {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    font-size: 0.875rem;
    font-weight: 600;
}

.channel-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 0.75rem;
}

.log-content {
    flex: 1;
}

.log-recipient {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 2px;
}

.log-message {
    color: var(--text-secondary);
    font-size: 0.875rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.log-status {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.log-status.sent { background: rgba(34, 197, 94, 0.1); color: #22c55e; }
.log-status.delivered { background: rgba(34, 197, 94, 0.2); color: #16a34a; }
.log-status.failed { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
.log-status.pending { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }

.log-timestamp {
    color: var(--text-muted);
    font-size: 0.75rem;
}

.log-actions {
    display: flex;
    gap: var(--spacing-xs);
}

.btn-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 1px solid var(--border-color);
    background: var(--card-bg);
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-icon:hover {
    background: var(--accent-orange);
    color: white;
    border-color: var(--accent-orange);
}

/* Template Management */
.template-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: var(--spacing-lg);
}

.template-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    padding: var(--spacing-lg);
    transition: all 0.3s ease;
}

.template-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.template-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: var(--spacing-md);
}

.template-title {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--spacing-xs);
}

.template-type {
    font-size: 0.75rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.template-actions {
    display: flex;
    gap: var(--spacing-xs);
}

.template-preview {
    background: var(--bg-secondary);
    border-radius: var(--border-radius);
    padding: var(--spacing-md);
    font-size: 0.875rem;
    color: var(--text-secondary);
    line-height: 1.4;
    margin-bottom: var(--spacing-md);
    max-height: 100px;
    overflow: hidden;
    position: relative;
}

.template-preview::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 20px;
    background: linear-gradient(transparent, var(--bg-secondary));
}

.template-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
    color: var(--text-muted);
}

.template-status {
    padding: 2px 6px;
    border-radius: 8px;
    font-weight: 600;
}

.template-status.active {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
}

.template-status.inactive {
    background: rgba(107, 114, 128, 0.1);
    color: #6b7280;
}

/* Modal Styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    backdrop-filter: blur(4px);
}

.modal-content {
    background: var(--card-bg);
    border-radius: var(--border-radius);
    max-width: 90vw;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    animation: modalSlideIn 0.3s ease-out;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal-header {
    padding: var(--spacing-xl);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.modal-header h3 {
    margin: 0;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.modal-header h3 i {
    color: var(--accent-orange);
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--text-muted);
    cursor: pointer;
    padding: var(--spacing-xs);
    border-radius: 50%;
    transition: all 0.3s ease;
}

.modal-close:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.modal-body {
    padding: var(--spacing-xl);
}

.modal-footer {
    padding: var(--spacing-xl);
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: var(--spacing-sm);
    justify-content: flex-end;
}

/* Form Styles */
.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-lg);
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-label {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--spacing-xs);
}

.form-input, .form-select, .form-textarea {
    padding: var(--spacing-sm);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    background: var(--input-bg);
    color: var(--text-primary);
    font-size: 0.875rem;
    transition: all 0.3s ease;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: none;
    border-color: var(--accent-orange);
    box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.2);
}

.form-textarea {
    resize: vertical;
    min-height: 100px;
}

.recipient-selector {
    background: var(--bg-secondary);
    border-radius: var(--border-radius);
    padding: var(--spacing-lg);
    margin: var(--spacing-lg) 0;
}

.recipient-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
    margin-top: var(--spacing-md);
}

.recipient-option {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-md);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: all 0.3s ease;
}

.recipient-option:hover {
    background: rgba(255, 107, 53, 0.05);
    border-color: var(--accent-orange);
}

.recipient-option input[type="checkbox"] {
    margin: 0;
}

/* Responsive Design */
@media (max-width: 768px) {
    .notification-dashboard {
        grid-template-columns: 1fr;
    }
    
    .notification-stats-grid {
        grid-template-columns: 1fr;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .notification-log-item {
        grid-template-columns: 1fr;
        gap: var(--spacing-sm);
    }
    
    .log-filters {
        flex-direction: column;
        align-items: stretch;
    }
    
    .modal-content {
        margin: var(--spacing-md);
        max-width: calc(100vw - 2 * var(--spacing-md));
    }
}
</style>
{% endblock %}

{% block content_body %}
<!-- Notification Statistics -->
<div class="notification-stats-grid">
    <div class="notification-stat-card">
        <div class="stat-header">
            <div class="stat-icon sms">
                <i class="fas fa-sms"></i>
            </div>
            <div class="stat-value">{{ notification_stats.sms.total or 0 }}</div>
        </div>
        <div class="stat-label">SMS Messages</div>
        <div class="stat-details">
            <span class="stat-success">{{ notification_stats.sms.delivered or 0 }} delivered</span>
            <span class="stat-failed">{{ notification_stats.sms.failed or 0 }} failed</span>
        </div>
    </div>
    
    <div class="notification-stat-card">
        <div class="stat-header">
            <div class="stat-icon whatsapp">
                <i class="fab fa-whatsapp"></i>
            </div>
            <div class="stat-value">{{ notification_stats.whatsapp.total or 0 }}</div>
        </div>
        <div class="stat-label">WhatsApp Messages</div>
        <div class="stat-details">
            <span class="stat-success">{{ notification_stats.whatsapp.delivered or 0 }} delivered</span>
            <span class="stat-failed">{{ notification_stats.whatsapp.failed or 0 }} failed</span>
        </div>
    </div>
    
    <div class="notification-stat-card">
        <div class="stat-header">
            <div class="stat-icon email">
                <i class="fas fa-envelope"></i>
            </div>
            <div class="stat-value">{{ notification_stats.email.total or 0 }}</div>
        </div>
        <div class="stat-label">Email Messages</div>
        <div class="stat-details">
            <span class="stat-success">{{ notification_stats.email.delivered or 0 }} delivered</span>
            <span class="stat-failed">{{ notification_stats.email.failed or 0 }} failed</span>
        </div>
    </div>
    
    <div class="notification-stat-card">
        <div class="stat-header">
            <div class="stat-icon in-app">
                <i class="fas fa-bell"></i>
            </div>
            <div class="stat-value">{{ notification_stats.in_app.total or 0 }}</div>
        </div>
        <div class="stat-label">In-App Notifications</div>
        <div class="stat-details">
            <span class="stat-success">{{ notification_stats.in_app.delivered or 0 }} delivered</span>
            <span class="stat-pending">{{ notification_stats.in_app.pending or 0 }} pending</span>
        </div>
    </div>
</div>

<!-- Notification Management Tabs -->
<div class="notification-tabs">
    <button class="tab-btn active" onclick="switchTab('logs')">
        <i class="fas fa-list"></i> Notification Logs
    </button>
    <button class="tab-btn" onclick="switchTab('templates')">
        <i class="fas fa-edit"></i> Message Templates
    </button>
    <button class="tab-btn" onclick="switchTab('settings')">
        <i class="fas fa-cog"></i> Settings
    </button>
</div>

<!-- Notification Logs Tab -->
<div id="logsTab" class="tab-content active">
    <div class="notification-log-table">
        <div class="log-filters">
            <div class="filter-group">
                <label>Channel:</label>
                <select class="filter-select" id="channelFilter" onchange="filterLogs()">
                    <option value="">All Channels</option>
                    <option value="sms">SMS</option>
                    <option value="whatsapp">WhatsApp</option>
                    <option value="email">Email</option>
                    <option value="in_app">In-App</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Status:</label>
                <select class="filter-select" id="statusFilter" onchange="filterLogs()">
                    <option value="">All Status</option>
                    <option value="sent">Sent</option>
                    <option value="delivered">Delivered</option>
                    <option value="failed">Failed</option>
                    <option value="pending">Pending</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Type:</label>
                <select class="filter-select" id="typeFilter" onchange="filterLogs()">
                    <option value="">All Types</option>
                    <option value="attendance_alert">Attendance Alert</option>
                    <option value="fee_reminder">Fee Reminder</option>
                    <option value="fee_confirmation">Fee Confirmation</option>
                    <option value="holiday_announcement">Holiday Announcement</option>
                    <option value="general_announcement">General Announcement</option>
                </select>
            </div>
            
            <div class="filter-group">
                <button class="btn btn-outline btn-sm" onclick="refreshLogs()">
                    <i class="fas fa-refresh"></i> Refresh
                </button>
            </div>
        </div>
        
        <div id="notificationLogs">
            {% for log in notification_logs %}
            <div class="notification-log-item" data-channel="{{ log.channel.value }}" data-status="{{ log.status.value }}" data-type="{{ log.type.value }}">
                <div class="log-channel">
                    <div class="channel-icon {{ log.channel.value }}">
                        {% if log.channel.value == 'sms' %}
                            <i class="fas fa-sms"></i>
                        {% elif log.channel.value == 'whatsapp' %}
                            <i class="fab fa-whatsapp"></i>
                        {% elif log.channel.value == 'email' %}
                            <i class="fas fa-envelope"></i>
                        {% else %}
                            <i class="fas fa-bell"></i>
                        {% endif %}
                    </div>
                    {{ log.channel.value.upper() }}
                </div>
                
                <div class="log-content">
                    <div class="log-recipient">{{ log.recipient_name }}</div>
                    <div class="log-message">{{ log.message[:100] }}{% if log.message|length > 100 %}...{% endif %}</div>
                </div>
                
                <div class="log-status {{ log.status.value }}">
                    {{ log.status.value }}
                </div>
                
                <div class="log-timestamp">
                    {{ log.created_at.strftime('%d/%m/%Y %H:%M') }}
                </div>
                
                <div class="log-actions">
                    <button class="btn-icon" onclick="viewLogDetails({{ log.id }})" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    {% if log.status.value == 'failed' %}
                    <button class="btn-icon" onclick="retryNotification({{ log.id }})" title="Retry">
                        <i class="fas fa-redo"></i>
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Message Templates Tab -->
<div id="templatesTab" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
        <h3>Message Templates</h3>
        <button class="btn btn-primary" onclick="showCreateTemplateModal()">
            <i class="fas fa-plus"></i> Create Template
        </button>
    </div>
    
    <div class="template-grid">
        {% for template in notification_templates %}
        <div class="template-card">
            <div class="template-header">
                <div>
                    <div class="template-title">{{ template.name }}</div>
                    <div class="template-type">{{ template.type.value.replace('_', ' ').title() }} â€¢ {{ template.channel.value.upper() }}</div>
                </div>
                <div class="template-actions">
                    <button class="btn-icon" onclick="editTemplate({{ template.id }})" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-icon" onclick="deleteTemplate({{ template.id }})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            
            <div class="template-preview">
                {{ template.message_template }}
            </div>
            
            <div class="template-meta">
                <span class="template-status {{ 'active' if template.is_active else 'inactive' }}">
                    {{ 'Active' if template.is_active else 'Inactive' }}
                </span>
                <span>{{ template.created_at.strftime('%d/%m/%Y') }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Settings Tab -->
<div id="settingsTab" class="tab-content">
    <div class="settings-grid">
        <div class="settings-section">
            <h3>SMS Configuration</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">SMS Gateway</label>
                    <select class="form-select">
                        <option>TextLocal</option>
                        <option>MSG91</option>
                        <option>Twilio</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">API Key</label>
                    <input type="password" class="form-input" placeholder="Enter API Key">
                </div>
                <div class="form-group">
                    <label class="form-label">Sender ID</label>
                    <input type="text" class="form-input" placeholder="SCHOOL" maxlength="6">
                </div>
            </div>
        </div>
        
        <div class="settings-section">
            <h3>WhatsApp Configuration</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">Business Account ID</label>
                    <input type="text" class="form-input" placeholder="Enter Business Account ID">
                </div>
                <div class="form-group">
                    <label class="form-label">Access Token</label>
                    <input type="password" class="form-input" placeholder="Enter Access Token">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number ID</label>
                    <input type="text" class="form-input" placeholder="Enter Phone Number ID">
                </div>
            </div>
        </div>
        
        <div class="settings-section">
            <h3>Email Configuration</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">SMTP Server</label>
                    <input type="text" class="form-input" placeholder="smtp.gmail.com">
                </div>
                <div class="form-group">
                    <label class="form-label">SMTP Port</label>
                    <input type="number" class="form-input" placeholder="587">
                </div>
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="email" class="form-input" placeholder="school@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" placeholder="Enter Password">
                </div>
            </div>
        </div>
    </div>
    
    <div style="margin-top: var(--spacing-xl);">
        <button class="btn btn-primary">
            <i class="fas fa-save"></i> Save Configuration
        </button>
        <button class="btn btn-outline" onclick="testConfiguration()">
            <i class="fas fa-vial"></i> Test Configuration
        </button>
    </div>
</div>
{% endblock %}

<!-- Send Notification Modal -->
<div id="sendNotificationModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3><i class="fas fa-paper-plane"></i> Send Notification</h3>
            <button class="modal-close" onclick="closeModal('sendNotificationModal')">&times;</button>
        </div>
        
        <div class="modal-body">
            <form id="sendNotificationForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Notification Type</label>
                        <select class="form-select" id="notificationType" onchange="updateTemplates()">
                            <option value="general_announcement">General Announcement</option>
                            <option value="holiday_announcement">Holiday Announcement</option>
                            <option value="fee_reminder">Fee Reminder</option>
                            <option value="exam_notification">Exam Notification</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Channel</label>
                        <select class="form-select" id="notificationChannel">
                            <option value="sms">SMS</option>
                            <option value="whatsapp">WhatsApp</option>
                            <option value="email">Email</option>
                        </select>
                    </div>
                </div>
                
                <div class="recipient-selector">
                    <h4>Select Recipients</h4>
                    <div class="recipient-options">
                        <label class="recipient-option">
                            <input type="checkbox" name="recipients" value="all_parents">
                            <span>All Parents</span>
                        </label>
                        <label class="recipient-option">
                            <input type="checkbox" name="recipients" value="all_teachers">
                            <span>All Teachers</span>
                        </label>
                        <label class="recipient-option">
                            <input type="checkbox" name="recipients" value="class_specific">
                            <span>Specific Classes</span>
                        </label>
                        <label class="recipient-option">
                            <input type="checkbox" name="recipients" value="custom">
                            <span>Custom Selection</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Subject (for Email)</label>
                    <input type="text" class="form-input" id="notificationSubject" placeholder="Enter subject">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Message</label>
                    <textarea class="form-textarea" id="notificationMessage" rows="6" placeholder="Enter your message here..."></textarea>
                    <small style="color: var(--text-muted); margin-top: var(--spacing-xs);">
                        Available variables: {{student_name}}, {{class_name}}, {{school_name}}, {{date}}
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Schedule (Optional)</label>
                    <input type="datetime-local" class="form-input" id="scheduleTime">
                </div>
            </form>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeModal('sendNotificationModal')">Cancel</button>
            <button class="btn btn-secondary" onclick="previewNotification()">
                <i class="fas fa-eye"></i> Preview
            </button>
            <button class="btn btn-primary" onclick="sendNotification()">
                <i class="fas fa-paper-plane"></i> Send Now
            </button>
        </div>
    </div>
</div>

{% block extra_js %}
{{ super() }}
<script>
// Tab Management
function switchTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab content
    document.getElementById(tabName + 'Tab').classList.add('active');
    
    // Add active class to clicked tab button
    event.target.classList.add('active');
}

// Notification Management Functions
function showSendNotificationModal() {
    document.getElementById('sendNotificationModal').style.display = 'flex';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function filterLogs() {
    const channelFilter = document.getElementById('channelFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    
    const logItems = document.querySelectorAll('.notification-log-item');
    
    logItems.forEach(item => {
        const channel = item.dataset.channel;
        const status = item.dataset.status;
        const type = item.dataset.type;
        
        const showChannel = !channelFilter || channel === channelFilter;
        const showStatus = !statusFilter || status === statusFilter;
        const showType = !typeFilter || type === typeFilter;
        
        if (showChannel && showStatus && showType) {
            item.style.display = 'grid';
        } else {
            item.style.display = 'none';
        }
    });
}

function refreshLogs() {
    location.reload();
}

function viewLogDetails(logId) {
    // Fetch and display log details
    fetch(`{{ url_for('school_admin.get_notification_log') }}/${logId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showLogDetailsModal(data.log);
            } else {
                showNotification('Error loading log details: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred while loading log details.', 'error');
        });
}

function retryNotification(logId) {
    if (confirm('Are you sure you want to retry sending this notification?')) {
        fetch(`{{ url_for('school_admin.retry_notification') }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ log_id: logId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Notification retry initiated successfully.', 'success');
                refreshLogs();
            } else {
                showNotification('Error retrying notification: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('An error occurred while retrying notification.', 'error');
        });
    }
}

function sendNotification() {
    const form = document.getElementById('sendNotificationForm');
    const formData = new FormData(form);
    
    const notificationData = {
        type: document.getElementById('notificationType').value,
        channel: document.getElementById('notificationChannel').value,
        subject: document.getElementById('notificationSubject').value,
        message: document.getElementById('notificationMessage').value,
        schedule_time: document.getElementById('scheduleTime').value,
        recipients: Array.from(document.querySelectorAll('input[name="recipients"]:checked')).map(cb => cb.value)
    };
    
    if (!notificationData.message.trim()) {
        showNotification('Please enter a message.', 'error');
        return;
    }
    
    if (notificationData.recipients.length === 0) {
        showNotification('Please select at least one recipient group.', 'error');
        return;
    }
    
    // Show loading state
    const sendBtn = event.target;
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
    sendBtn.disabled = true;
    
    fetch(`{{ url_for('school_admin.send_notification') }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(notificationData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`Notification sent successfully to ${data.sent_count} recipients.`, 'success');
            closeModal('sendNotificationModal');
            refreshLogs();
        } else {
            showNotification('Error sending notification: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while sending notification.', 'error');
    })
    .finally(() => {
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Now';
        sendBtn.disabled = false;
    });
}

function previewNotification() {
    const message = document.getElementById('notificationMessage').value;
    const subject = document.getElementById('notificationSubject').value;
    
    if (!message.trim()) {
        showNotification('Please enter a message to preview.', 'error');
        return;
    }
    
    // Show preview modal with sample data
    const previewMessage = message
        .replace(/\{\{student_name\}\}/g, 'John Doe')
        .replace(/\{\{class_name\}\}/g, 'Class 10-A')
        .replace(/\{\{school_name\}\}/g, '{{ school.name }}')
        .replace(/\{\{date\}\}/g, new Date().toLocaleDateString());
    
    alert(`Preview:\n\nSubject: ${subject}\n\nMessage: ${previewMessage}`);
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
        ${message}
    `;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white;
        padding: 1rem;
        border-radius: 8px;
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

// Template Management Functions
function showCreateTemplateModal() {
    showNotification('Template creation feature coming soon.', 'info');
}

function editTemplate(templateId) {
    showNotification('Template editing feature coming soon.', 'info');
}

function deleteTemplate(templateId) {
    if (confirm('Are you sure you want to delete this template?')) {
        showNotification('Template deletion feature coming soon.', 'info');
    }
}

function testConfiguration() {
    showNotification('Configuration test feature coming soon.', 'info');
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Set current date/time for schedule input
    const scheduleInput = document.getElementById('scheduleTime');
    if (scheduleInput) {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        scheduleInput.min = now.toISOString().slice(0, 16);
    }
});
</script>
{% endblock %}