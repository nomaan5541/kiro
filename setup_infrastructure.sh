#!/bin/bash\n\n# Infrastructure Setup Script for School Management System\n# Sets up PostgreSQL, Redis, and other required services\n\nset -e  # Exit on any error\n\n# Colors for output\nRED='\\033[0;31m'\nGREEN='\\033[0;32m'\nYELLOW='\\033[1;33m'\nBLUE='\\033[0;34m'\nNC='\\033[0m' # No Color\n\n# Logging function\nlog() {\n    echo -e \"${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1\"\n}\n\nlog_success() {\n    echo -e \"${GREEN}[SUCCESS]${NC} $1\"\n}\n\nlog_warning() {\n    echo -e \"${YELLOW}[WARNING]${NC} $1\"\n}\n\nlog_error() {\n    echo -e \"${RED}[ERROR]${NC} $1\"\n}\n\n# Check if running as root\ncheck_root() {\n    if [[ $EUID -eq 0 ]]; then\n        log_warning \"This script should not be run as root for security reasons\"\n        read -p \"Continue anyway? (y/N): \" -n 1 -r\n        echo\n        if [[ ! $REPLY =~ ^[Yy]$ ]]; then\n            exit 1\n        fi\n    fi\n}\n\n# Detect OS\ndetect_os() {\n    if [[ \"$OSTYPE\" == \"linux-gnu\"* ]]; then\n        if [ -f /etc/debian_version ]; then\n            OS=\"debian\"\n            log \"Detected Debian/Ubuntu system\"\n        elif [ -f /etc/redhat-release ]; then\n            OS=\"redhat\"\n            log \"Detected RedHat/CentOS/Fedora system\"\n        else\n            OS=\"linux\"\n            log \"Detected generic Linux system\"\n        fi\n    elif [[ \"$OSTYPE\" == \"darwin\"* ]]; then\n        OS=\"macos\"\n        log \"Detected macOS system\"\n    else\n        OS=\"unknown\"\n        log_error \"Unsupported operating system: $OSTYPE\"\n        exit 1\n    fi\n}\n\n# Install PostgreSQL\ninstall_postgresql() {\n    log \"Installing PostgreSQL...\"\n    \n    case $OS in\n        \"debian\")\n            sudo apt update\n            sudo apt install -y postgresql postgresql-contrib postgresql-client\n            ;;\n        \"redhat\")\n            sudo yum install -y postgresql-server postgresql-contrib\n            sudo postgresql-setup initdb\n            ;;\n        \"macos\")\n            if command -v brew &> /dev/null; then\n                brew install postgresql\n                brew services start postgresql\n            else\n                log_error \"Homebrew not found. Please install Homebrew first.\"\n                exit 1\n            fi\n            ;;\n        *)\n            log_error \"Unsupported OS for automatic PostgreSQL installation\"\n            exit 1\n            ;;\n    esac\n    \n    # Start PostgreSQL service\n    if [[ \"$OS\" != \"macos\" ]]; then\n        sudo systemctl start postgresql\n        sudo systemctl enable postgresql\n    fi\n    \n    log_success \"PostgreSQL installed successfully\"\n}\n\n# Configure PostgreSQL\nconfigure_postgresql() {\n    log \"Configuring PostgreSQL...\"\n    \n    # Create database and user\n    DB_NAME=\"school_management\"\n    DB_USER=\"school_admin\"\n    DB_PASSWORD=$(openssl rand -base64 32)\n    \n    # Create database and user\n    sudo -u postgres psql << EOF\nCREATE DATABASE ${DB_NAME};\nCREATE USER ${DB_USER} WITH ENCRYPTED PASSWORD '${DB_PASSWORD}';\nGRANT ALL PRIVILEGES ON DATABASE ${DB_NAME} TO ${DB_USER};\nALTER USER ${DB_USER} CREATEDB;\n\\q\nEOF\n    \n    # Save credentials to .env file\n    echo \"# PostgreSQL Configuration\" >> .env\n    echo \"DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@localhost:5432/${DB_NAME}\" >> .env\n    echo \"POSTGRESQL_USER=${DB_USER}\" >> .env\n    echo \"POSTGRESQL_PASSWORD=${DB_PASSWORD}\" >> .env\n    echo \"POSTGRESQL_DATABASE=${DB_NAME}\" >> .env\n    \n    log_success \"PostgreSQL configured successfully\"\n    log \"Database credentials saved to .env file\"\n}\n\n# Install Redis\ninstall_redis() {\n    log \"Installing Redis...\"\n    \n    case $OS in\n        \"debian\")\n            sudo apt install -y redis-server\n            ;;\n        \"redhat\")\n            sudo yum install -y redis\n            ;;\n        \"macos\")\n            if command -v brew &> /dev/null; then\n                brew install redis\n                brew services start redis\n            else\n                log_error \"Homebrew not found. Please install Homebrew first.\"\n                exit 1\n            fi\n            ;;\n        *)\n            log_error \"Unsupported OS for automatic Redis installation\"\n            exit 1\n            ;;\n    esac\n    \n    # Start Redis service\n    if [[ \"$OS\" != \"macos\" ]]; then\n        sudo systemctl start redis\n        sudo systemctl enable redis\n    fi\n    \n    # Add Redis configuration to .env\n    echo \"\" >> .env\n    echo \"# Redis Configuration\" >> .env\n    echo \"REDIS_URL=redis://localhost:6379/0\" >> .env\n    \n    log_success \"Redis installed successfully\"\n}\n\n# Install Python dependencies\ninstall_python_deps() {\n    log \"Installing Python dependencies...\"\n    \n    # Check if virtual environment exists\n    if [ ! -d \"venv\" ]; then\n        log \"Creating virtual environment...\"\n        python3 -m venv venv\n    fi\n    \n    # Activate virtual environment\n    source venv/bin/activate\n    \n    # Upgrade pip\n    pip install --upgrade pip\n    \n    # Install requirements\n    if [ -f \"requirements_enhanced.txt\" ]; then\n        pip install -r requirements_enhanced.txt\n    elif [ -f \"requirements.txt\" ]; then\n        pip install -r requirements.txt\n    else\n        log_error \"No requirements file found\"\n        exit 1\n    fi\n    \n    log_success \"Python dependencies installed successfully\"\n}\n\n# Setup directories\nsetup_directories() {\n    log \"Setting up directories...\"\n    \n    # Create necessary directories\n    mkdir -p logs\n    mkdir -p uploads\n    mkdir -p backups\n    mkdir -p instance\n    mkdir -p migrations\n    \n    # Set permissions\n    chmod 755 logs uploads backups instance\n    \n    log_success \"Directories created successfully\"\n}\n\n# Initialize database\ninit_database() {\n    log \"Initializing database...\"\n    \n    # Activate virtual environment\n    source venv/bin/activate\n    \n    # Set Flask environment\n    export FLASK_APP=app.py\n    export FLASK_ENV=development\n    \n    # Initialize Flask-Migrate\n    if [ ! -d \"migrations\" ]; then\n        flask db init\n    fi\n    \n    # Create migration\n    flask db migrate -m \"Initial migration\"\n    \n    # Apply migration\n    flask db upgrade\n    \n    # Initialize with sample data\n    if [ -f \"init_db.py\" ]; then\n        python init_db.py\n    fi\n    \n    log_success \"Database initialized successfully\"\n}\n\n# Setup systemd services (Linux only)\nsetup_systemd_services() {\n    if [[ \"$OS\" == \"debian\" ]] || [[ \"$OS\" == \"redhat\" ]]; then\n        log \"Setting up systemd services...\"\n        \n        # Create systemd service file for the application\n        sudo tee /etc/systemd/system/school-management.service > /dev/null << EOF\n[Unit]\nDescription=School Management System\nAfter=network.target postgresql.service redis.service\nRequires=postgresql.service redis.service\n\n[Service]\nType=notify\nUser=$(whoami)\nGroup=$(whoami)\nWorkingDirectory=$(pwd)\nEnvironment=PATH=$(pwd)/venv/bin\nEnvironmentFile=$(pwd)/.env\nExecStart=$(pwd)/venv/bin/gunicorn --bind 0.0.0.0:5000 --workers 4 --timeout 120 app:app\nExecReload=/bin/kill -s HUP \\$MAINPID\nRestart=always\nRestartSec=10\n\n[Install]\nWantedBy=multi-user.target\nEOF\n        \n        # Reload systemd and enable service\n        sudo systemctl daemon-reload\n        sudo systemctl enable school-management.service\n        \n        log_success \"Systemd service created successfully\"\n    fi\n}\n\n# Setup backup cron job\nsetup_backup_cron() {\n    log \"Setting up backup cron job...\"\n    \n    # Create backup script\n    cat > backup_script.sh << 'EOF'\n#!/bin/bash\n\n# Load environment variables\nsource .env\n\n# Create backup directory\nBACKUP_DIR=\"backups/$(date +%Y-%m-%d_%H-%M-%S)\"\nmkdir -p \"$BACKUP_DIR\"\n\n# Backup database\npg_dump \"$DATABASE_URL\" > \"$BACKUP_DIR/database.sql\"\n\n# Backup uploaded files\ntar -czf \"$BACKUP_DIR/uploads.tar.gz\" uploads/\n\n# Compress backup\ntar -czf \"$BACKUP_DIR.tar.gz\" -C backups \"$(basename $BACKUP_DIR)\"\nrm -rf \"$BACKUP_DIR\"\n\n# Keep only last 30 days of backups\nfind backups/ -name \"*.tar.gz\" -mtime +30 -delete\n\necho \"Backup completed: $BACKUP_DIR.tar.gz\"\nEOF\n    \n    chmod +x backup_script.sh\n    \n    # Add to crontab (daily at 2 AM)\n    (crontab -l 2>/dev/null; echo \"0 2 * * * cd $(pwd) && ./backup_script.sh >> logs/backup.log 2>&1\") | crontab -\n    \n    log_success \"Backup cron job configured successfully\"\n}\n\n# Setup monitoring\nsetup_monitoring() {\n    log \"Setting up basic monitoring...\"\n    \n    # Create monitoring script\n    cat > monitor_system.py << 'EOF'\n#!/usr/bin/env python3\n\"\"\"\nBasic system monitoring script\n\"\"\"\n\nimport psutil\nimport redis\nimport psycopg2\nimport json\nimport time\nfrom datetime import datetime\n\ndef check_postgresql():\n    try:\n        # Load database URL from environment\n        import os\n        from urllib.parse import urlparse\n        \n        db_url = os.environ.get('DATABASE_URL')\n        if not db_url:\n            return {'status': 'error', 'message': 'DATABASE_URL not set'}\n        \n        parsed = urlparse(db_url)\n        conn = psycopg2.connect(\n            host=parsed.hostname,\n            port=parsed.port,\n            user=parsed.username,\n            password=parsed.password,\n            database=parsed.path[1:]\n        )\n        \n        cursor = conn.cursor()\n        cursor.execute('SELECT 1')\n        conn.close()\n        \n        return {'status': 'ok', 'message': 'PostgreSQL is running'}\n    except Exception as e:\n        return {'status': 'error', 'message': str(e)}\n\ndef check_redis():\n    try:\n        r = redis.Redis(host='localhost', port=6379, db=0)\n        r.ping()\n        return {'status': 'ok', 'message': 'Redis is running'}\n    except Exception as e:\n        return {'status': 'error', 'message': str(e)}\n\ndef get_system_stats():\n    return {\n        'cpu_percent': psutil.cpu_percent(interval=1),\n        'memory_percent': psutil.virtual_memory().percent,\n        'disk_percent': psutil.disk_usage('/').percent,\n        'timestamp': datetime.now().isoformat()\n    }\n\ndef main():\n    status = {\n        'postgresql': check_postgresql(),\n        'redis': check_redis(),\n        'system': get_system_stats()\n    }\n    \n    print(json.dumps(status, indent=2))\n    \n    # Log to file\n    with open('logs/system_status.log', 'a') as f:\n        f.write(f\"{datetime.now().isoformat()}: {json.dumps(status)}\\n\")\n\nif __name__ == '__main__':\n    main()\nEOF\n    \n    chmod +x monitor_system.py\n    \n    # Add monitoring to crontab (every 5 minutes)\n    (crontab -l 2>/dev/null; echo \"*/5 * * * * cd $(pwd) && ./venv/bin/python monitor_system.py >> logs/monitor.log 2>&1\") | crontab -\n    \n    log_success \"Basic monitoring configured successfully\"\n}\n\n# Create environment file template\ncreate_env_template() {\n    if [ ! -f \".env\" ]; then\n        log \"Creating .env file...\"\n        \n        cat > .env << EOF\n# Flask Configuration\nFLASK_ENV=development\nFLASK_APP=app.py\nSECRET_KEY=$(openssl rand -base64 32)\n\n# JWT Configuration\nJWT_SECRET_KEY=$(openssl rand -base64 32)\n\n# Security\nSECURITY_PASSWORD_SALT=$(openssl rand -base64 32)\n\n# File Upload\nMAX_CONTENT_LENGTH=52428800\nUPLOAD_FOLDER=uploads\n\n# Email Configuration (Update with your SMTP settings)\n# MAIL_SERVER=smtp.gmail.com\n# MAIL_PORT=587\n# MAIL_USE_TLS=true\n# MAIL_USERNAME=your-email@gmail.com\n# MAIL_PASSWORD=your-app-password\n\n# SMS Configuration (Update with your provider settings)\n# SMS_API_KEY=your-sms-api-key\n# SMS_API_URL=your-sms-api-url\n\n# Payment Gateway Configuration\n# RAZORPAY_KEY_ID=your-razorpay-key-id\n# RAZORPAY_KEY_SECRET=your-razorpay-key-secret\n\n# AWS S3 Configuration (Optional)\n# AWS_ACCESS_KEY_ID=your-aws-access-key\n# AWS_SECRET_ACCESS_KEY=your-aws-secret-key\n# AWS_S3_BUCKET=your-s3-bucket\n# AWS_S3_REGION=us-east-1\n\n# Backup Configuration\nBACKUP_ENABLED=true\nBACKUP_SCHEDULE=daily\nBACKUP_RETENTION_DAYS=30\n\n# Monitoring\nLOG_LEVEL=INFO\nENABLE_QUERY_LOGGING=false\nSLOW_QUERY_THRESHOLD=0.5\nEOF\n        \n        log_success \".env file created successfully\"\n    else\n        log \"Using existing .env file\"\n    fi\n}\n\n# Main installation function\nmain() {\n    echo \"School Management System - Infrastructure Setup\"\n    echo \"===============================================\"\n    echo\n    \n    # Check prerequisites\n    check_root\n    detect_os\n    \n    # Create environment file\n    create_env_template\n    \n    # Install services\n    log \"Starting infrastructure setup...\"\n    \n    install_postgresql\n    configure_postgresql\n    install_redis\n    \n    # Setup application\n    setup_directories\n    install_python_deps\n    init_database\n    \n    # Setup services and monitoring\n    setup_systemd_services\n    setup_backup_cron\n    setup_monitoring\n    \n    echo\n    log_success \"Infrastructure setup completed successfully!\"\n    echo\n    echo \"Next steps:\"\n    echo \"1. Review and update the .env file with your specific configuration\"\n    echo \"2. Configure email, SMS, and payment gateway settings\"\n    echo \"3. Start the application: source venv/bin/activate && flask run\"\n    echo \"4. Access the application at http://localhost:5000\"\n    echo\n    echo \"Default login credentials:\"\n    echo \"Super Admin: admin@schoolsystem.com / admin123\"\n    echo \"School Admin: demo@school.com / school123\"\n    echo \"Teacher: teacher@demo.com / teacher123\"\n    echo \"Student: student@demo.com / student123\"\n    echo\n}\n\n# Run main function\nmain \"$@\"\n