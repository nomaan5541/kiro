# Infrastructure Setup Script for School Management System (Windows)\n# Sets up PostgreSQL, Redis, and other required services on Windows\n\nparam(\n    [switch]$SkipPostgreSQL,\n    [switch]$SkipRedis,\n    [switch]$DryRun\n)\n\n# Colors for output\n$Red = \"Red\"\n$Green = \"Green\"\n$Yellow = \"Yellow\"\n$Blue = \"Blue\"\n\n# Logging functions\nfunction Write-Log {\n    param([string]$Message, [string]$Color = \"White\")\n    $timestamp = Get-Date -Format \"yyyy-MM-dd HH:mm:ss\"\n    Write-Host \"[$timestamp] $Message\" -ForegroundColor $Color\n}\n\nfunction Write-Success {\n    param([string]$Message)\n    Write-Log \"[SUCCESS] $Message\" -Color $Green\n}\n\nfunction Write-Warning {\n    param([string]$Message)\n    Write-Log \"[WARNING] $Message\" -Color $Yellow\n}\n\nfunction Write-Error {\n    param([string]$Message)\n    Write-Log \"[ERROR] $Message\" -Color $Red\n}\n\n# Check if running as administrator\nfunction Test-Administrator {\n    $currentUser = [Security.Principal.WindowsIdentity]::GetCurrent()\n    $principal = New-Object Security.Principal.WindowsPrincipal($currentUser)\n    return $principal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)\n}\n\n# Check prerequisites\nfunction Test-Prerequisites {\n    Write-Log \"Checking prerequisites...\"\n    \n    # Check if running as administrator\n    if (-not (Test-Administrator)) {\n        Write-Warning \"This script should be run as Administrator for best results\"\n        $continue = Read-Host \"Continue anyway? (y/N)\"\n        if ($continue -ne \"y\" -and $continue -ne \"Y\") {\n            exit 1\n        }\n    }\n    \n    # Check if Chocolatey is installed\n    if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {\n        Write-Log \"Installing Chocolatey package manager...\"\n        Set-ExecutionPolicy Bypass -Scope Process -Force\n        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072\n        iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))\n        refreshenv\n    }\n    \n    # Check if Python is installed\n    if (-not (Get-Command python -ErrorAction SilentlyContinue)) {\n        Write-Log \"Installing Python...\"\n        choco install python -y\n        refreshenv\n    }\n    \n    Write-Success \"Prerequisites checked\"\n}\n\n# Install PostgreSQL\nfunction Install-PostgreSQL {\n    if ($SkipPostgreSQL) {\n        Write-Log \"Skipping PostgreSQL installation\"\n        return\n    }\n    \n    Write-Log \"Installing PostgreSQL...\"\n    \n    # Check if PostgreSQL is already installed\n    $pgService = Get-Service -Name \"postgresql*\" -ErrorAction SilentlyContinue\n    if ($pgService) {\n        Write-Log \"PostgreSQL service already exists\"\n    } else {\n        # Install PostgreSQL using Chocolatey\n        choco install postgresql -y --params '/Password:postgres123'\n        \n        # Wait for service to start\n        Start-Sleep -Seconds 10\n    }\n    \n    # Add PostgreSQL to PATH if not already there\n    $pgPath = \"C:\\Program Files\\PostgreSQL\\*\\bin\"\n    $pgBinPath = Get-ChildItem -Path $pgPath -Directory | Select-Object -First 1 -ExpandProperty FullName\n    \n    if ($pgBinPath -and $env:PATH -notlike \"*$pgBinPath*\") {\n        $env:PATH += \";$pgBinPath\"\n        [Environment]::SetEnvironmentVariable(\"PATH\", $env:PATH, [EnvironmentVariableTarget]::Machine)\n    }\n    \n    Write-Success \"PostgreSQL installed successfully\"\n}\n\n# Configure PostgreSQL\nfunction Configure-PostgreSQL {\n    if ($SkipPostgreSQL) {\n        return\n    }\n    \n    Write-Log \"Configuring PostgreSQL...\"\n    \n    $dbName = \"school_management\"\n    $dbUser = \"school_admin\"\n    $dbPassword = [System.Web.Security.Membership]::GeneratePassword(16, 4)\n    \n    # Create database and user\n    $sqlCommands = @\"\nCREATE DATABASE $dbName;\nCREATE USER $dbUser WITH ENCRYPTED PASSWORD '$dbPassword';\nGRANT ALL PRIVILEGES ON DATABASE $dbName TO $dbUser;\nALTER USER $dbUser CREATEDB;\n\"@\n    \n    # Execute SQL commands\n    try {\n        $env:PGPASSWORD = \"postgres123\"\n        $sqlCommands | psql -U postgres -h localhost\n        \n        # Save credentials to .env file\n        Add-Content -Path \".env\" -Value \"\"\n        Add-Content -Path \".env\" -Value \"# PostgreSQL Configuration\"\n        Add-Content -Path \".env\" -Value \"DATABASE_URL=postgresql://$dbUser`:$dbPassword@localhost:5432/$dbName\"\n        Add-Content -Path \".env\" -Value \"POSTGRESQL_USER=$dbUser\"\n        Add-Content -Path \".env\" -Value \"POSTGRESQL_PASSWORD=$dbPassword\"\n        Add-Content -Path \".env\" -Value \"POSTGRESQL_DATABASE=$dbName\"\n        \n        Write-Success \"PostgreSQL configured successfully\"\n        Write-Log \"Database credentials saved to .env file\"\n    }\n    catch {\n        Write-Error \"Failed to configure PostgreSQL: $($_.Exception.Message)\"\n    }\n}\n\n# Install Redis\nfunction Install-Redis {\n    if ($SkipRedis) {\n        Write-Log \"Skipping Redis installation\"\n        return\n    }\n    \n    Write-Log \"Installing Redis...\"\n    \n    # Check if Redis is already installed\n    if (Get-Command redis-server -ErrorAction SilentlyContinue) {\n        Write-Log \"Redis already installed\"\n    } else {\n        # Install Redis using Chocolatey\n        choco install redis-64 -y\n        \n        # Start Redis service\n        Start-Service redis\n        Set-Service -Name redis -StartupType Automatic\n    }\n    \n    # Add Redis configuration to .env\n    Add-Content -Path \".env\" -Value \"\"\n    Add-Content -Path \".env\" -Value \"# Redis Configuration\"\n    Add-Content -Path \".env\" -Value \"REDIS_URL=redis://localhost:6379/0\"\n    \n    Write-Success \"Redis installed successfully\"\n}\n\n# Install Python dependencies\nfunction Install-PythonDependencies {\n    Write-Log \"Installing Python dependencies...\"\n    \n    # Check if virtual environment exists\n    if (-not (Test-Path \"venv\")) {\n        Write-Log \"Creating virtual environment...\"\n        python -m venv venv\n    }\n    \n    # Activate virtual environment\n    & \".\\venv\\Scripts\\Activate.ps1\"\n    \n    # Upgrade pip\n    python -m pip install --upgrade pip\n    \n    # Install requirements\n    if (Test-Path \"requirements_enhanced.txt\") {\n        pip install -r requirements_enhanced.txt\n    }\n    elseif (Test-Path \"requirements.txt\") {\n        pip install -r requirements.txt\n    }\n    else {\n        Write-Error \"No requirements file found\"\n        exit 1\n    }\n    \n    Write-Success \"Python dependencies installed successfully\"\n}\n\n# Setup directories\nfunction Setup-Directories {\n    Write-Log \"Setting up directories...\"\n    \n    # Create necessary directories\n    $directories = @(\"logs\", \"uploads\", \"backups\", \"instance\", \"migrations\")\n    \n    foreach ($dir in $directories) {\n        if (-not (Test-Path $dir)) {\n            New-Item -ItemType Directory -Path $dir -Force | Out-Null\n        }\n    }\n    \n    Write-Success \"Directories created successfully\"\n}\n\n# Initialize database\nfunction Initialize-Database {\n    Write-Log \"Initializing database...\"\n    \n    # Activate virtual environment\n    & \".\\venv\\Scripts\\Activate.ps1\"\n    \n    # Set Flask environment\n    $env:FLASK_APP = \"app.py\"\n    $env:FLASK_ENV = \"development\"\n    \n    try {\n        # Initialize Flask-Migrate\n        if (-not (Test-Path \"migrations\")) {\n            flask db init\n        }\n        \n        # Create migration\n        flask db migrate -m \"Initial migration\"\n        \n        # Apply migration\n        flask db upgrade\n        \n        # Initialize with sample data\n        if (Test-Path \"init_db.py\") {\n            python init_db.py\n        }\n        \n        Write-Success \"Database initialized successfully\"\n    }\n    catch {\n        Write-Error \"Failed to initialize database: $($_.Exception.Message)\"\n    }\n}\n\n# Setup Windows Task Scheduler for backups\nfunction Setup-BackupTask {\n    Write-Log \"Setting up backup task...\"\n    \n    # Create backup script\n    $backupScript = @'\n# Backup script for School Management System\n$ErrorActionPreference = \"Stop\"\n\n# Load environment variables from .env file\nGet-Content \".env\" | ForEach-Object {\n    if ($_ -match \"^([^#][^=]+)=(.*)$\") {\n        [Environment]::SetEnvironmentVariable($matches[1], $matches[2], \"Process\")\n    }\n}\n\n# Create backup directory\n$backupDir = \"backups\\$(Get-Date -Format 'yyyy-MM-dd_HH-mm-ss')\"\nNew-Item -ItemType Directory -Path $backupDir -Force\n\n# Backup database\n$env:PGPASSWORD = $env:POSTGRESQL_PASSWORD\npg_dump -h localhost -U $env:POSTGRESQL_USER -d $env:POSTGRESQL_DATABASE > \"$backupDir\\database.sql\"\n\n# Backup uploaded files\nCompress-Archive -Path \"uploads\\*\" -DestinationPath \"$backupDir\\uploads.zip\" -Force\n\n# Compress entire backup\nCompress-Archive -Path $backupDir -DestinationPath \"$backupDir.zip\" -Force\nRemove-Item -Path $backupDir -Recurse -Force\n\n# Keep only last 30 days of backups\nGet-ChildItem -Path \"backups\" -Filter \"*.zip\" | Where-Object { $_.CreationTime -lt (Get-Date).AddDays(-30) } | Remove-Item -Force\n\nWrite-Host \"Backup completed: $backupDir.zip\"\n'@\n    \n    $backupScript | Out-File -FilePath \"backup_script.ps1\" -Encoding UTF8\n    \n    # Create scheduled task\n    $action = New-ScheduledTaskAction -Execute \"PowerShell.exe\" -Argument \"-File `\"$(Get-Location)\\backup_script.ps1`\"\" -WorkingDirectory (Get-Location)\n    $trigger = New-ScheduledTaskTrigger -Daily -At \"2:00AM\"\n    $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries\n    \n    try {\n        Register-ScheduledTask -TaskName \"SchoolManagementBackup\" -Action $action -Trigger $trigger -Settings $settings -Force\n        Write-Success \"Backup task scheduled successfully\"\n    }\n    catch {\n        Write-Warning \"Failed to create scheduled task: $($_.Exception.Message)\"\n    }\n}\n\n# Create environment file template\nfunction Create-EnvironmentFile {\n    if (-not (Test-Path \".env\")) {\n        Write-Log \"Creating .env file...\"\n        \n        $secretKey = [System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes([System.Guid]::NewGuid().ToString()))\n        $jwtSecret = [System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes([System.Guid]::NewGuid().ToString()))\n        $passwordSalt = [System.Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes([System.Guid]::NewGuid().ToString()))\n        \n        $envContent = @\"\n# Flask Configuration\nFLASK_ENV=development\nFLASK_APP=app.py\nSECRET_KEY=$secretKey\n\n# JWT Configuration\nJWT_SECRET_KEY=$jwtSecret\n\n# Security\nSECURITY_PASSWORD_SALT=$passwordSalt\n\n# File Upload\nMAX_CONTENT_LENGTH=52428800\nUPLOAD_FOLDER=uploads\n\n# Email Configuration (Update with your SMTP settings)\n# MAIL_SERVER=smtp.gmail.com\n# MAIL_PORT=587\n# MAIL_USE_TLS=true\n# MAIL_USERNAME=your-email@gmail.com\n# MAIL_PASSWORD=your-app-password\n\n# SMS Configuration (Update with your provider settings)\n# SMS_API_KEY=your-sms-api-key\n# SMS_API_URL=your-sms-api-url\n\n# Payment Gateway Configuration\n# RAZORPAY_KEY_ID=your-razorpay-key-id\n# RAZORPAY_KEY_SECRET=your-razorpay-key-secret\n\n# AWS S3 Configuration (Optional)\n# AWS_ACCESS_KEY_ID=your-aws-access-key\n# AWS_SECRET_ACCESS_KEY=your-aws-secret-key\n# AWS_S3_BUCKET=your-s3-bucket\n# AWS_S3_REGION=us-east-1\n\n# Backup Configuration\nBACKUP_ENABLED=true\nBACKUP_SCHEDULE=daily\nBACKUP_RETENTION_DAYS=30\n\n# Monitoring\nLOG_LEVEL=INFO\nENABLE_QUERY_LOGGING=false\nSLOW_QUERY_THRESHOLD=0.5\n\"@\n        \n        $envContent | Out-File -FilePath \".env\" -Encoding UTF8\n        Write-Success \".env file created successfully\"\n    }\n    else {\n        Write-Log \"Using existing .env file\"\n    }\n}\n\n# Main installation function\nfunction Main {\n    Write-Host \"School Management System - Infrastructure Setup (Windows)\" -ForegroundColor $Blue\n    Write-Host \"================================================================\" -ForegroundColor $Blue\n    Write-Host \"\"\n    \n    if ($DryRun) {\n        Write-Warning \"DRY RUN MODE - No actual changes will be made\"\n        return\n    }\n    \n    try {\n        # Check prerequisites\n        Test-Prerequisites\n        \n        # Create environment file\n        Create-EnvironmentFile\n        \n        # Install services\n        Write-Log \"Starting infrastructure setup...\"\n        \n        Install-PostgreSQL\n        Configure-PostgreSQL\n        Install-Redis\n        \n        # Setup application\n        Setup-Directories\n        Install-PythonDependencies\n        Initialize-Database\n        \n        # Setup backup task\n        Setup-BackupTask\n        \n        Write-Host \"\"\n        Write-Success \"Infrastructure setup completed successfully!\"\n        Write-Host \"\"\n        Write-Host \"Next steps:\" -ForegroundColor $Yellow\n        Write-Host \"1. Review and update the .env file with your specific configuration\"\n        Write-Host \"2. Configure email, SMS, and payment gateway settings\"\n        Write-Host \"3. Start the application: .\\venv\\Scripts\\Activate.ps1 && flask run\"\n        Write-Host \"4. Access the application at http://localhost:5000\"\n        Write-Host \"\"\n        Write-Host \"Default login credentials:\" -ForegroundColor $Green\n        Write-Host \"Super Admin: admin@schoolsystem.com / admin123\"\n        Write-Host \"School Admin: demo@school.com / school123\"\n        Write-Host \"Teacher: teacher@demo.com / teacher123\"\n        Write-Host \"Student: student@demo.com / student123\"\n        Write-Host \"\"\n    }\n    catch {\n        Write-Error \"Setup failed: $($_.Exception.Message)\"\n        exit 1\n    }\n}\n\n# Run main function\nMain\n